name: Deploy Locaweb

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Instalar Composer
      run: |
        sudo apt-get update
        sudo apt-get install -y composer

    - name: Instalar dependências com Composer
      run: composer install --no-dev --prefer-dist --no-interaction

    - name: Criar arquivo .env
      run: |
        echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> .env
        echo "SMTP_PORT=${{ secrets.SMTP_PORT }}" >> .env
        echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
        echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
        echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> .env
        echo "GEMINI_URL=${{ secrets.GEMINI_URL }}" >> .env

    # -----------------------
    # 1️⃣ Enviar somente public_html/
    # -----------------------
    - name: Upload para /public_html
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASS }}
        local-dir: ./src
        server-dir: public_html/src

    - name: Upload index.php
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASS }}
        local-dir: .
        server-dir: public_html
        include: |
          index.php

    # -----------------------
    # 2️⃣ Enviar vendor/ para /home/<user>/vendor
    # -----------------------
    - name: Upload vendor/
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASS }}
        local-dir: vendor
        server-dir: vendor

    # -----------------------
    # 3️⃣ Enviar .env para /home/<user>/
    # -----------------------
    - name: Upload .env
      uses: SamKirkland/FTP-Deploy-Action@v4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASS }}
        local-dir: .
        server-dir: .
        include: |
          .env
